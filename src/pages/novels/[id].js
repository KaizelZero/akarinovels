import { useRouter } from "next/router";
import supabase from "@/utils/supabase";
import Head from "next/head";
import Banner from "@/components/Banner";
import { Button } from "@chakra-ui/react";
import { useSession, useSupabaseClient } from "@supabase/auth-helpers-react";

export async function getServerSideProps(context) {
	const { id } = context.query;

	const { data: novel, error: novelError } = await supabase
		.from("Novels")
		.select("*")
		.eq("id", id)
		.single();

	return {
		props: {
			novel,
		},
	};
}

export default function Novel({ novel }) {
	const router = useRouter();
	const { id } = router.query;
	const session = useSession();

	const addToLibrary = async () => {
		const { data, error } = await supabase
			.from("Library")
			.select("*")
			.eq("user_id", session.user.id)
			.eq("novel_id", id);

		if (data?.length === 0 || data === null) {
			const { data, error } = await supabase.from("Library").insert([
				{
					user_id: session.user.id,
					novel_id: id,
					username: session.user.user_metadata.name,
				},
			]);

			if (error) {
				console.log(error);
			} else {
				console.log(data);
			}
		}
	};

	return (
		<>
			<Head>
				<title>{novel.title}</title>
				<meta name="description" content="Generated by create next app" />
				<meta name="viewport" content="width=device-width, initial-scale=1" />
				<link rel="icon" href="/favicon.ico" />
			</Head>

			<Banner title={novel.title} file={novel.cover} />

			<div className="flex flex-col items-center">
				<div className="flex flex-col items-center">
					<img
						src={novel.cover}
						alt={novel.title}
						width="286px"
						height="400px"
					/>
					{session && <Button onClick={addToLibrary}>Add To Library</Button>}
					<div className="flex flex-col items-center">
						<h1 className="text-2xl font-bold">{novel.title}</h1>
						<h2 className="text-xl font-bold">{novel.author}</h2>
					</div>
				</div>
				<div className="flex flex-col items-center">
					<h1 className="text-2xl font-bold">Synopsis</h1>
					<p className="text-xl">{novel.description}</p>
				</div>
			</div>
		</>
	);
}
